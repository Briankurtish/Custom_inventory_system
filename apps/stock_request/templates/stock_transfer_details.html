{% extends layout_path %}

{% load static %}
{% load i18n %}

{% block title %}{% trans "Stock Transfer Details" %}{% endblock %}

{% block content %}

<h4 class="text">{% trans "Stock Transfer Details" %}</h4>
<nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{% url 'index' %}">{% trans "Dashboard" %}</a></li>
      <li class="breadcrumb-item"><a href="{% url 'transfers' %}">{% trans "Stock Transfers" %}</a></li>
      <li class="breadcrumb-item active" aria-current="page">{% trans "Transfer Details" %}</li>
    </ol>
</nav>
<hr class="my-8">

<!-- Modal for Confirming Stock Received -->
<div class="modal fade" id="confirmStockReceivedModal" tabindex="-1" aria-labelledby="confirmStockReceivedModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmStockReceivedModalLabel">{% trans "Confirm Stock Received" %}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="stockReceivedForm" action="{% url 'complete-transfer' transfer_id=stock_transfer.transfer_id %}" method="post">
          {% csrf_token %}

          <!-- Date Received Field -->
          <div class="mb-3">
            <label for="date_received" class="form-label">{% trans "Date Received" %}</label>
            <input type="date" name="date_received" id="date_received" class="form-control" required>
          </div>

          <div class="table-responsive">
            <table class="table table-bordered">
              <thead>
                <tr>
                  <th>{% trans "Generic Name" %}</th>
                  <th>{% trans "Brand Name" %}</th>
                  <th>{% trans "Batch Number" %}</th>
                  <th>{% trans "Transferred Quantity" %}</th>
                  <th>{% trans "Actual Quantity Received" %}</th>
                </tr>
              </thead>
              <tbody>
                {% for item in transfer_items %}
                  <tr>
                    <td>{{ item.product.generic_name_dosage }}</td>
                    <td>{{ item.product.brand_name.brand_name }}</td>
                    <td>{{ item.batch.batch_number|default:"No Batch" }}</td>
                    <td>{{ item.quantity }}</td>
                    <td>
                      <input type="number" name="actual_quantity_{{ item.id }}" class="form-control" min="0" required>
                    </td>
                  </tr>
                {% empty %}
                  <tr>
                    <td colspan="5" class="text-center">{% trans "No items found for this transfer." %}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Close" %}</button>
            <button type="submit" class="btn btn-primary">{% trans "Confirm Receipt" %}</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="card">
    <div class="row">
        <h5 class="text col-md-5 m-3">{{ stock_transfer.transfer_id }}</h5>
    </div>
    <hr>

    <div class="container">
        <div class="row">
            <!-- First Column -->
            <div class="col-md-3">
                <small class="text m-3">{% trans "Source Branch ID" %}</small>
                <h6 class="mx-3">{{ stock_transfer.source_branch.branch_id }}</h6>
            </div>

            <!-- Second Column -->
            <div class="col-md-3">
                <small class="text m-3">{% trans "Source Branch Name" %}</small>
                <h6 class="mx-3">{{ stock_transfer.source_branch.branch_name }}</h6>
            </div>

            <!-- Third Column -->
            <div class="col-md-3">
                <small class="text m-3">{% trans "Destination Branch Name" %}</small>
                <h6 class="mx-3">{{ stock_transfer.destination_branch.branch_name }}</h6>
            </div>

            <!-- Fourth Column -->
            <div class="col-md-3">
                <small class="text m-3">{% trans "Date Transferred" %}</small>
                <h6 class="mx-3">{{ stock_transfer.date_transferred|date:"M d, Y" }}</h6>
            </div>
        </div>
    </div>
    <hr>

    <div class="container">
        <div class="row">
            <!-- First Column -->
            <div class="col-md-4">
                <small class="text m-3">{% trans "Transferred By" %}</small>
                <h6 class="mx-3">{{ stock_transfer.transferred_by.user.first_name }} {{ stock_transfer.transferred_by.user.last_name }}</h6>
            </div>

            <!-- Second Column -->
            <div class="col-md-4">
                <small class="text m-3">{% trans "Status" %}</small>
                <h6 class="mx-3
                    {% if stock_transfer.status == 'Pending' %}badge bg-label-warning
                    {% elif stock_transfer.status == 'Received' %}badge bg-label-success
                    {% elif stock_transfer.status == 'Cancelled' %}badge bg-label-danger
                    {% endif %}">
                    {{ stock_transfer.status }}
                </h6>
            </div>
        </div>
    </div>

    <div class="card">
      <h5 class="card-header">{% trans "Transfer Items" %}</h5>
      <div class="table-responsive text-nowrap">
          <table class="table table-hover">
              <thead>
                  <tr>
                      <th>{% trans "Product Code" %}</th>
                      <th>{% trans "Generic Name" %}</th>
                      <th>{% trans "Brand Name" %}</th>
                      <th>{% trans "Batch Number" %}</th>
                      <th>{% trans "Dosage Form" %}</th>
                      <th>{% trans "Pack Size" %}</th>
                      <th>{% trans "Quantity" %}</th>
                  </tr>
              </thead>
              <tbody>
                  {% for item in transfer_items %}
                      <tr>
                          <td>{{ item.product.product_code }}</td>
                          <td>{{ item.product.generic_name_dosage }}</td>
                          <td>{{ item.product.brand_name.brand_name }}</td>
                          <td>{{ item.batch.batch_number|default:"No Batch" }}</td>
                          <td>{{ item.product.dosage_form }}</td>
                          <td>{{ item.product.pack_size }}</td>
                          <td>{{ item.quantity }}</td>
                      </tr>
                  {% empty %}
                      <tr>
                          <td colspan="7" class="text-center">{% trans "No items found for this transfer" %}</td>
                      </tr>
                  {% endfor %}
              </tbody>
          </table>
      </div>
    </div>
</div>

<div class="mt-3">
  {% if stock_transfer.status == "Pending" %}
    {% if role_privileges %}
        {% for privilege in role_privileges %}
            {% if privilege.name == 'Generate Order Picking List' %}
                <a href="{% url 'picking_list_doc_transfer' stock_transfer.transfer_id %}" target="_blank" class="btn btn-primary">
                    {% trans "Download Picking List" %}
                </a>
            {% endif %}
        {% endfor %}
    {% endif %}
    <a href="{% url 'transfer_slip_doc_transfer' stock_transfer.transfer_id %}" target="_blank" class="btn btn-primary">
      {% trans "Transfer Slip/Bon de Transfer" %}
  </a>
    {% if role_privileges %}
        {% for privilege in role_privileges %}
            {% if privilege.name == 'Transfer Stock' %}
            <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#confirmStockReceivedModal">
              <span class="fa-solid fa-circle-check"></span> &nbsp; {% trans "Complete Transfer" %}
            </button>
            {% endif %}
        {% endfor %}
    {% endif %}

{% comment %} 
    {% if privilege.name == 'Transfer Stock' %}
              <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#confirmStockReceivedModal">
                <span class="fa-solid fa-circle-check"></span> &nbsp; {% trans "Complete Transfer" %}
              </button>
            {% endif %} {% endcomment %}
            
    

    {% if user.is_superuser %}
    
    <a href="{% url 'picking_list_doc_transfer' stock_transfer.transfer_id %}" target="_blank" class="btn btn-primary">
        {% trans "Download Picking List" %}
    </a>
        <a href="{% url 'transfer_slip_doc_transfer' stock_transfer.transfer_id %}" target="_blank" class="btn btn-primary">
            {% trans "Transfer Slip/Bon de Transfer" %}
        </a>
      <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#confirmStockReceivedModal">
        <span class="fa-solid fa-circle-check"></span> {% trans "Complete Transfer" %}
      </button>
    {% endif %}
  {% endif %}

   {% if stock_transfer.status == "Received" %}
    <a href="{% url 'picking_list_doc_transfer' stock_transfer.transfer_id %}" target="_blank" class="btn btn-primary">
        {% trans "Download Picking List" %}
    </a>
    <a href="{% url 'transfer_slip_doc_transfer' stock_transfer.transfer_id %}" target="_blank" class="btn btn-primary">
        {% trans "Transfer Slip/Bon de Transfer" %}
    </a>
      <a href="{% url 'receipt_note_doc_transfer' stock_transfer.transfer_id %}" target="_blank" class="btn btn-primary">
        {% trans "Goods Receipt Note/Bon de Recu" %}
      </a>
  {% endif %} 

  
</div>

{% endblock %}