{% extends layout_path %}

{% load static %}
{% load i18n %}
{% load humanize %}

{% block title %}{% trans "Damaged Product List" %}{% endblock %}

{% block content %}

<!-- Add Damaged Product Button -->
<button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addDamagedProductModal">
  <i class="fa-solid fa-plus me-2"></i>{% trans "Add Damaged Product" %}
</button>

<!-- Search and Filter Form -->
<form method="GET" class="row g-2 align-items-center mb-3">
  <div class="col-auto">
    <label for="search_query" class="form-label">{% trans "Search" %}</label>
    <input type="text" id="search_query" name="search_query" class="form-control form-control-sm"
           placeholder="{% trans 'Search by generic name, brand name, or batch number' %}"
           value="{{ search_query }}">
  </div>

  <div class="col-auto">
    <label for="filter_branch" class="form-label">{% trans "Branch" %}</label>
    <select id="filter_branch" name="branch" class="form-select form-select-sm">
      <option value="">{% trans "All Branches" %}</option>
      {% for branch in branches %}
        <option value="{{ branch.id }}" {% if branch_id == branch.id|stringformat:"s" %}selected{% endif %}>
          {{ branch.branch_name }}
        </option>
      {% endfor %}
    </select>
  </div>

  <div class="col-auto">
    <label for="start_date" class="form-label">{% trans "Start Date" %}</label>
    <input type="date" id="start_date" name="start_date" class="form-control form-control-sm"
           value="{{ start_date }}">
  </div>

  <div class="col-auto">
    <label for="end_date" class="form-label">{% trans "End Date" %}</label>
    <input type="date" id="end_date" name="end_date" class="form-control form-control-sm"
           value="{{ end_date }}">
  </div>

  <div class="col-auto">
    <button type="submit" class="btn btn-primary btn-sm mt-4">{% trans "Filter" %}</button>
  </div>
</form>

<!-- Add Damaged Product Modal -->
<div class="modal fade" id="addDamagedProductModal" tabindex="-1" aria-labelledby="addDamagedProductModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addDamagedProductModalLabel">{% trans "Add Damaged Product" %}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="addDamagedProductForm">
          {% csrf_token %}
          <div class="mb-3">
            <label for="product" class="form-label">{% trans "Product" %}</label>
            <select class="form-control" id="product" name="product" required>
              <option value="">{% trans "Select a product" %}</option>
              {% for product in products %}
                <option value="{{ product.id }}">{{ product.brand_name.brand_name }} - {{ product.generic_name_dosage }} - {{ product.batch.batch_number }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label for="modal_branch" class="form-label">{% trans "Branch" %}</label>
            <select class="form-control" id="modal_branch" name="branch" required>
              <option value="">{% trans "Select a branch" %}</option>
              {% for branch in branches %}
                <option value="{{ branch.id }}">{{ branch.branch_name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label for="quantity" class="form-label">{% trans "Quantity" %}</label>
            <input type="number" class="form-control" id="quantity" name="quantity" required min="1">
          </div>
          <div class="mb-3">
            <label for="notes" class="form-label">{% trans "Notes" %}</label>
            <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Close" %}</button>
        <button type="button" class="btn btn-primary" id="saveDamagedProduct">{% trans "Save" %}</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Damaged Product Modal -->
<div class="modal fade" id="editDamagedProductModal" tabindex="-1" aria-labelledby="editDamagedProductModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editDamagedProductModalLabel">{% trans "Edit Damaged Product" %}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="editDamagedProductForm">
          {% csrf_token %}
          <input type="hidden" id="edit_product_id" name="product_id">
          <div class="mb-3">
            <label class="form-label">{% trans "Product" %}</label>
            <input type="text" class="form-control" id="edit_product_display" readonly>
          </div>
          <div class="mb-3">
            <label class="form-label">{% trans "Branch" %}</label>
            <input type="text" class="form-control" id="edit_branch_display" readonly>
          </div>
          <div class="mb-3">
            <label for="edit_quantity" class="form-label">{% trans "Quantity" %}</label>
            <input type="number" class="form-control" id="edit_quantity" name="quantity" required min="1">
          </div>
  <div class="mb-3">
            <label for="edit_notes" class="form-label">{% trans "Notes" %}</label>
            <textarea class="form-control" id="edit_notes" name="notes" rows="3"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Close" %}</button>
        <button type="button" class="btn btn-primary" id="saveEditDamagedProduct">{% trans "Save Changes" %}</button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteDamagedProductModal" tabindex="-1" aria-labelledby="deleteDamagedProductModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteDamagedProductModalLabel">{% trans "Delete Damaged Product" %}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-warning">
          <h4 class="alert-heading">{% trans "Warning!" %}</h4>
          <p>{% trans "Are you sure you want to delete this damaged product record?" %}</p>
          <hr>
          <p class="mb-0" id="delete_product_details"></p>
        </div>
        <input type="hidden" id="delete_product_id">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans "Cancel" %}</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteDamagedProduct">{% trans "Delete" %}</button>
      </div>
    </div>
  </div>
</div>

<!-- Damaged Products Table -->
<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0">{% trans "Damaged Products" %}</h5>
    <div class="d-flex">
      <input type="text" id="searchInput" class="form-control me-2" placeholder="{% trans 'Search...' %}">
    </div>
  </div>
  <div class="table-responsive text-nowrap">
    <table class="table table-hover">
      <thead>
        <tr>
          <th>{% trans "No" %}</th>
          <th>{% trans "Generic Name" %}</th>
          <th>{% trans "Brand Name" %}</th>
          <th>{% trans "Batch Number" %}</th>
          <th>{% trans "Branch" %}</th>
          <th>{% trans "Quantity" %}</th>
          <th>{% trans "Date Recorded" %}</th>
          <th>{% trans "Recorded By" %}</th>
          <th>{% trans "Notes" %}</th>
          <th>{% trans "Actions" %}</th>
        </tr>
      </thead>
      <tbody>
        {% for product in damaged_products %}
          <tr>
          <td>{{ forloop.counter|add:offset }}</td>
          <td>{{ product.product.generic_name_dosage }}</td>
          <td>{{ product.product.brand_name.brand_name }}</td>
          <td>{{ product.product.batch.batch_number }}</td>
          <td>{{ product.branch.branch_name }}</td>
          <td>{{ product.quantity }}</td>
          <td>{{ product.date_recorded|date:"Y-m-d H:i" }}</td>
          <td>{{ product.created_by }}</td>
          <td>{{ product.notes|default:"-" }}</td>
          <td>
            <div class="dropdown">
              <button type="button" class="btn p-0 dropdown-toggle hide-arrow" data-bs-toggle="dropdown">
                <i class="fa-solid fa-ellipsis-vertical"></i>
              </button>
              <div class="dropdown-menu">
                <a class="dropdown-item edit-damaged-product" href="#"
                   data-id="{{ product.id }}"
                   data-product="{{ product.product.brand_name.brand_name }} - {{ product.product.generic_name_dosage }} - {{ product.product.batch.batch_number }}"
                   data-branch="{{ product.branch.branch_name }}"
                   data-quantity="{{ product.quantity }}"
                   data-notes="{{ product.notes|default:'' }}">
                  <i class="fa-solid fa-pencil me-1"></i> {% trans "Edit" %}
                </a>
                <a class="dropdown-item delete-damaged-product" href="#"
                   data-id="{{ product.id }}"
                   data-product="{{ product.product.brand_name.brand_name }} - {{ product.product.generic_name_dosage }} - {{ product.product.batch.batch_number }}"
                   data-branch="{{ product.branch.branch_name }}"
                   data-quantity="{{ product.quantity }}"
                   data-date="{{ product.date_recorded|date:'Y-m-d H:i' }}">
                  <i class="fa-solid fa-trash me-1"></i> {% trans "Delete" %}
                </a>
              </div>
            </div>
          </td>
          </tr>
        {% empty %}
          <tr>
          <td colspan="10" class="text-center">{% trans "No damaged products found" %}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Pagination -->
<div class="d-flex justify-content-center mt-4">
  <nav aria-label="Page navigation">
    <ul class="pagination">
      {% if damaged_products.has_previous %}
      <li class="page-item">
        <a class="page-link" href="?page={{ damaged_products.previous_page_number }}{% if search_query %}&search_query={{ search_query }}{% endif %}" aria-label="Previous">
          <span aria-hidden="true">&laquo;</span>
        </a>
      </li>
      {% endif %}

      {% for num in damaged_products.paginator.page_range %}
      <li class="page-item {% if damaged_products.number == num %}active{% endif %}">
        <a class="page-link" href="?page={{ num }}{% if search_query %}&search_query={{ search_query }}{% endif %}">{{ num }}</a>
      </li>
      {% endfor %}

      {% if damaged_products.has_next %}
      <li class="page-item">
        <a class="page-link" href="?page={{ damaged_products.next_page_number }}{% if search_query %}&search_query={{ search_query }}{% endif %}" aria-label="Next">
          <span aria-hidden="true">&raquo;</span>
        </a>
      </li>
      {% endif %}
    </ul>
  </nav>
</div>

{% endblock %}

{% block page_js %}
<script>
$(document).ready(function() {
  // Initialize Select2 for dropdowns
  $('#product').select2({
    placeholder: "{% trans 'Select a product' %}",
    allowClear: true,
    width: '100%',
    dropdownParent: $('#addDamagedProductModal')
  });

  $('#modal_branch').select2({
    placeholder: "{% trans 'Select a branch' %}",
    allowClear: true,
    width: '100%',
    dropdownParent: $('#addDamagedProductModal')
  });

  // Handle Add form submission
  $('#saveDamagedProduct').click(function() {
    const form = $('#addDamagedProductForm');
    const formData = new FormData(form[0]);

    $.ajax({
      url: "{% url 'add-damaged-product' %}",
      type: 'POST',
      data: formData,
      processData: false,
      contentType: false,
      success: function(response) {
        if (response.success) {
          $('#addDamagedProductModal').modal('hide');
          window.location.reload();
        } else {
          alert(response.error);
        }
      },
      error: function() {
        alert("{% trans 'An error occurred while saving the damaged product.' %}");
      }
    });
  });

  // Handle Edit button click
  $('.edit-damaged-product').click(function(e) {
    e.preventDefault();
    const id = $(this).data('id');
    const product = $(this).data('product');
    const branch = $(this).data('branch');
    const quantity = $(this).data('quantity');
    const notes = $(this).data('notes');

    $('#edit_product_id').val(id);
    $('#edit_product_display').val(product);
    $('#edit_branch_display').val(branch);
    $('#edit_quantity').val(quantity);
    $('#edit_notes').val(notes);

    $('#editDamagedProductModal').modal('show');
  });

  // Handle Edit form submission
  $('#saveEditDamagedProduct').click(function() {
    const id = $('#edit_product_id').val();
    const quantity = $('#edit_quantity').val();
    const notes = $('#edit_notes').val();

    $.ajax({
      url: "{% url 'edit-damaged-product' 0 %}".replace('0', id),
      type: 'POST',
      data: {
        'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val(),
        'quantity': quantity,
        'notes': notes
      },
      success: function(response) {
        if (response.success) {
          $('#editDamagedProductModal').modal('hide');
          window.location.reload();
        } else {
          alert(response.error);
        }
      },
      error: function(xhr, status, error) {
        console.error('Error:', error);
        alert("{% trans 'An error occurred while updating the damaged product.' %}");
      }
    });
  });

  // Handle Delete button click
  $('.delete-damaged-product').click(function(e) {
    e.preventDefault();
    const id = $(this).data('id');
    const product = $(this).data('product');
    const branch = $(this).data('branch');
    const quantity = $(this).data('quantity');
    const date = $(this).data('date');

    $('#delete_product_id').val(id);
    $('#delete_product_details').html(`
      <strong>{% trans "Product:" %}</strong> ${product}<br>
      <strong>{% trans "Branch:" %}</strong> ${branch}<br>
      <strong>{% trans "Quantity:" %}</strong> ${quantity}<br>
      <strong>{% trans "Date Recorded:" %}</strong> ${date}
    `);

    $('#deleteDamagedProductModal').modal('show');
  });

  // Handle Delete confirmation
  $('#confirmDeleteDamagedProduct').click(function() {
    const id = $('#delete_product_id').val();

    $.ajax({
      url: "{% url 'delete-damaged-product' 0 %}".replace('0', id),
      type: 'POST',
      data: {
        'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val()
      },
      success: function(response) {
        if (response.success) {
          $('#deleteDamagedProductModal').modal('hide');
          window.location.reload();
        } else {
          alert(response.error);
        }
      },
      error: function(xhr, status, error) {
        console.error('Error:', error);
        alert("{% trans 'An error occurred while deleting the damaged product.' %}");
      }
    });
  });

  // Search functionality
  $('#searchInput').on('keyup', function() {
    const value = $(this).val().toLowerCase();
    $('table tbody tr').filter(function() {
      $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
    });
  });
});
</script>
{% endblock %}
