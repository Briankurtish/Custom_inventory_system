{% extends layout_path %}

{% load static %}
{% load i18n %}

{% block title %}Order Details{% endblock %}

{% block content %}

<h4 class="text">Order Details</h4>
<nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{% url 'index' %}">Dashboard</a></li>
      <li class="breadcrumb-item active"><a href="{% url 'orders' %}">Orders</a></li>
      <li class="breadcrumb-item active" aria-current="page">Order Details</li>
    </ol>
  </nav>
<hr class="my-8">

<div class="card">
    <div class="row">
        <h5 class="text col-md-2 m-3">#ORD_{{ order.id }}</h5>
    </div>
    <hr>

    <div class="container">
        <div class="row">
            <!-- First Column -->
            <div class="col-md-4">
                <small class="text m-3">Branch ID</small>
                <h6 class="m-3">{{ order.branch.branch_id }}</h6>
            </div>

            <!-- Second Column -->
            <div class="col-md-4">
                <small class="text m-3">Branch Name</small>
                <h6 class="m-3">{{ order.branch.branch_name }}</h6>
            </div>

            <!-- Third Column -->
            <div class="col-md-4">
                <small class="text m-3">Created By</small>
                <h6 class=" m-3">{{ order.created_by.user.get_full_name }}</h6>
            </div>
        </div>
    </div>
    <hr>

    <div class="container">
        <div class="row">
            <!-- First Column -->
            <div class="col-md-4">
                <small class="text m-3">Customer Name</small>
                <h6 class="m-3">{{ order.customer.customer_name }}</h6>
                {% if 'View Customer Credits' in worker_privileges %}
                    <form action="{% url 'credit_report' customer_id=order.customer.id %}" method="get">
                        <button type="submit" class="btn btn-primary">
                            <span class="tf-icons bx bx-file bx-18px me-2"></span> Get Credit Report
                        </button>
                    </form>
                {% endif %}
                
                {% comment %} <a class="m-3 text-secondary " href="{% url 'credit_report' order.id %}">Get Credit Report</a> {% endcomment %}
            </div>

            <!-- Second Column -->
            <div class="col-md-4">
                <small class="text m-3">Sales Representative</small>
                <h6 class=" m-3">{{ order.sales_rep.user.get_full_name }}</h6>
                {% if 'View Sales Rep Credits' in worker_privileges %}
                    <form action="{% url 'sales_rep_credit_history' worker_id=order.sales_rep.id %}" method="get">
                        <button type="submit" class="btn btn-primary">
                            <span class="tf-icons bx bx-file bx-18px me-2"></span> Get Credit Report
                        </button>
                    </form>
                {% endif %}
                

            </div>

            <!-- Third Column -->
            <div class="col-md-4">
                <small class="text m-3">Payment Method</small>
                <h6 class=" m-3 text-primary">{{ order.payment_method }}</h6>
            </div>
        </div>
    </div>
    <hr>

    <div class="container">
        <div class="row">
            <!-- Status Column -->
            <div class="col-md-4">
                <small class="text m-3">Status</small>
                <h6 class="text-warning m-3">{{ order.status }}</h6>
            </div>

            <!-- Grand Total Column -->
            <div class="col-md-4">
                <small class="text m-3">Grand Total</small>
                <h6 class="m-3">{{ order.grand_total|floatformat:2 }} CFA</h6>
            </div>

            <!-- Date Column -->
            <div class="col-md-4">
                <small class="text m-3">Date Created</small>
                <h6 class=" m-3">{{ order.created_at|date:"M d, Y H:i" }}</h6>
            </div>
        </div>
    </div>
    <hr>

    <div class="card">
        <h5 class="card-header">Order Items</h5>
        <div class="table-responsive text-nowrap">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Product Code</th>
                        <th>Product Name</th>
                        <th>Unit Price</th>
                        <th>Quantity</th>
                        <th>Total Price</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in order_items %}
                        <tr>
                            <td>{{ item.stock.product.product_code }}</td>
                            <td>{{ item.stock.product.generic_name_dosage }}</td>
                            <td>{{ item.stock.product.unit_price|floatformat:2 }}</td>
                            <td>{{ item.quantity }}</td>
                            <td>{{ item.quantity|floatformat:2|floatformat:2 }}</td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="5" class="text-center">No items found for this order.</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="mt-3">
    {% if order.status == "Pending" %}
        <!-- Approve or Decline Form -->
        {% if user.worker_profile.role == "Sales Manager" %}
        <form action="{% url 'approve_or_decline_order' order_id=order.id %}" method="post">
            {% csrf_token %}
            <button type="submit" name="action" value="approve" class="btn btn-success">
                <span class="tf-icons bx bx-check bx-18px me-2"></span> Approve
            </button>
            <button type="submit" name="action" value="decline" class="btn btn-danger">
                <span class="tf-icons bx bx-x bx-18px me-2"></span> Decline
            </button>
        </form>
        {% endif %}
    {% endif %}
</div>

{% endblock %}
